---
import { Image } from 'astro:assets';

interface Service {
  title: string;
  image: any;
  color: string;
  bgGradient?: string;
  services?: string[];
  bgRight?: any;
  bgRightPosition?: string;
  button?: string;
}

interface Props {
  slides: Service[];
  lang?: string;
}

const { slides, lang = 'es' } = Astro.props;
---

<div class="services-carousel-wrapper">
  <div class="services-carousel" data-carousel="services">
    <div class="services-track">
      {slides.map((slide, index) => (
        <div class="service-slide" data-slide-index={index}>
          <div class="service-card" data-color={slide.color}>
            {/* Image Section */}
            <div class="service-image-section" style={`background-color: ${slide.color}`}>
              <div class="service-image-wrapper">
                <Image
                  src={slide.image}
                  alt={slide.title}
                  class="service-image"
                  loading={index === 1 ? "eager" : "lazy"}
                  format="webp"
                  width={680}
                  height={480}
                />
                <div class="service-gradient"></div>
                <div class="service-title-overlay">
                  <h3 class="service-title">{slide.title.replace(' & ', ' &\n')}</h3>
                </div>
              </div>
            </div>

            {/* Content Section */}
            <div 
              class="service-content-section" 
              style={{
                backgroundColor: slide.color
              }}
            >
              {slide.bgRight && (
                <Image
                  src={slide.bgRight}
                  alt=""
                  class="service-bg-decoration"
                  loading={index === 1 ? "eager" : "lazy"}
                  format="webp"
                  width={400}
                  height={400}
                  style={{
                    position: 'absolute',
                    right: 0,
                    top: slide.bgRightPosition?.includes('top') ? '15%' : '50%',
                    transform: 'translateY(-50%)',
                    height: '80%',
                    width: 'auto',
                    objectFit: 'contain',
                    pointerEvents: 'none',
                    zIndex: 0
                  }}
                />
              )}
              {slide.services && (
                <div class="service-content">
                  {/* Services List */}
                  <div class="services-list-wrapper">
                    <ul class="services-list">
                      {slide.services.map((service, idx) => (
                        <li class="service-item" style={`animation-delay: ${idx * 0.1}s`}>
                          <span class="service-bullet"></span>
                          <span class="service-text">{service}</span>
                        </li>
                      ))}
                    </ul>
                  </div>

                  {/* CTA Button */}
                  {slide.button && (
                    <button 
                      class="service-cta-btn"
                      data-open-modal
                      style={`color: ${slide.color}`}
                    >
                      {slide.button}
                    </button>
                  )}
                </div>
              )}
            </div>
          </div>
        </div>
      ))}
    </div>
  </div>
</div>

{/* Modal will be rendered by the section that includes this carousel */}

<script>
  function initServicesCarousel() {
    const carousel = document.querySelector('[data-carousel="services"]') as HTMLElement;
    if (!carousel) return;

    const track = carousel.querySelector('.services-track') as HTMLElement;
    const slides = Array.from(track.querySelectorAll('.service-slide')) as HTMLElement[];
    
    let selectedIndex = 1; // Start at second slide
    let expandedIndex: number | null = null;
    let isMobile = window.innerWidth < 1024;

    function scrollToSlide(index: number) {
      const slide = slides[index];
      if (!slide || !track) return;
      try {
        const left = slide.offsetLeft - (track.clientWidth - slide.clientWidth) / 2;
        track.scrollTo({ left, behavior: 'smooth' });
      } catch (err) {
        slide.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
      }
    }

    function updateSelectedSlide() {
      const trackRect = track.getBoundingClientRect();
      const centerX = trackRect.left + trackRect.width / 2;

      let closestIndex = 0;
      let closestDistance = Infinity;

      slides.forEach((slide, index) => {
        const slideRect = slide.getBoundingClientRect();
        const slideCenterX = slideRect.left + slideRect.width / 2;
        const distance = Math.abs(centerX - slideCenterX);

        if (distance < closestDistance) {
          closestDistance = distance;
          closestIndex = index;
        }
      });

      if (closestIndex !== selectedIndex) {
        selectedIndex = closestIndex;
        updateSlideStates();
      }
    }

    function updateSlideStates() {
      slides.forEach((slide, index) => {
        const card = slide.querySelector('.service-card') as HTMLElement;
        const isActive = index === selectedIndex;
        
        if (isMobile) {
          slide.style.transform = isActive ? 'scale(1)' : 'scale(0.85)';
          slide.style.opacity = isActive ? '1' : '0.5';
          slide.style.pointerEvents = isActive ? 'auto' : 'none';
        } else {
          slide.style.transform = 'scale(1)';
          slide.style.opacity = '1';
          slide.style.pointerEvents = 'auto';
        }
      });
    }

    function toggleExpand(index: number) {
      const slide = slides[index];
      const card = slide.querySelector('.service-card') as HTMLElement;
      
      if (expandedIndex === index) {
        // Collapse
        expandedIndex = null;
        card.classList.remove('expanded');
      } else {
        // Collapse others first
        slides.forEach(s => {
          const c = s.querySelector('.service-card') as HTMLElement;
          c.classList.remove('expanded');
        });
        
        // Expand this one
        expandedIndex = index;
        card.classList.add('expanded');
      }
    }

    // Click handlers
    slides.forEach((slide, index) => {
      const card = slide.querySelector('.service-card') as HTMLElement;
      
      card.addEventListener('click', (e) => {
        const target = e.target as HTMLElement;
        if (target.hasAttribute('data-open-modal') || target.closest('[data-open-modal]')) {
          return; // Let modal button handle its own click
        }

        if (isMobile) {
          const isActive = index === selectedIndex;
          if (isActive) {
            toggleExpand(index);
          } else {
            scrollToSlide(index);
          }
        } else {
          if (index !== selectedIndex) {
            scrollToSlide(index);
          }
          toggleExpand(index);
        }
      });
    });

    // Modal button handlers
    document.querySelectorAll('[data-open-modal]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        window.dispatchEvent(new CustomEvent('openSubscriptionModal'));
      });
    });

    let isDragging = false;
    let startX = 0;
    let currentX = 0;
    let startScrollLeft = 0;
    let velocityX = 0;
    let lastX = 0;
    let lastTime = 0;
    let rafId: number | null = null;
    const dragThreshold = 5;
    let hasMoved = false;

    const easeOutQuart = (t: number) => 1 - Math.pow(1 - t, 4);

    const applyMomentum = () => {
      if (Math.abs(velocityX) > 0.5) {
        track.scrollLeft -= velocityX;
        velocityX *= 0.92; // Smoother friction like Embla
        rafId = requestAnimationFrame(applyMomentum);
      } else {
        velocityX = 0;
        rafId = null;
      }
    };

    const handlePointerDown = (e: MouseEvent) => {
      if (e.button !== 0) return; // Only left click
      
      isDragging = true;
      hasMoved = false;
      track.style.cursor = 'grabbing';
      track.style.userSelect = 'none';
      track.style.scrollSnapType = 'none'; // Disable snap during drag
      
      startX = e.pageX;
      currentX = e.pageX;
      lastX = e.pageX;
      startScrollLeft = track.scrollLeft;
      lastTime = performance.now();
      velocityX = 0;
      
      if (rafId) {
        cancelAnimationFrame(rafId);
        rafId = null;
      }

      e.preventDefault();
    };

    const handlePointerMove = (e: MouseEvent) => {
      if (!isDragging) return;
      
      e.preventDefault();
      currentX = e.pageX;
      const deltaX = currentX - startX;
      
      if (!hasMoved && Math.abs(deltaX) > dragThreshold) {
        hasMoved = true;
      }
      
      if (hasMoved) {
        const now = performance.now();
        const deltaTime = now - lastTime;
        const distance = currentX - lastX;
        
        const targetScroll = startScrollLeft - deltaX;
        track.scrollLeft = targetScroll;
        
        if (deltaTime > 0) {
          velocityX = (distance / deltaTime) * 16; // Normalize to ~60fps
        }
        
        lastX = currentX;
        lastTime = now;
      }
    };

    const handlePointerUp = () => {
      if (!isDragging) return;
      
      isDragging = false;
      track.style.cursor = 'grab';
      track.style.userSelect = '';
      
      setTimeout(() => {
        if (!isDragging) {
          track.style.scrollSnapType = 'x mandatory';
        }
      }, 50);
      
      if (hasMoved && Math.abs(velocityX) > 0.5) {
        applyMomentum();
      }
    };

    track.addEventListener('mousedown', handlePointerDown);
    document.addEventListener('mousemove', handlePointerMove);
    document.addEventListener('mouseup', handlePointerUp);
    
    track.addEventListener('click', (e) => {
      if (hasMoved) {
        e.preventDefault();
        e.stopPropagation();
      }
    }, true);
    // Scroll tracking
    let scrollTimeout: number;
    track.addEventListener('scroll', () => {
      clearTimeout(scrollTimeout);
      scrollTimeout = window.setTimeout(() => {
        updateSelectedSlide();
      }, 150);
    });

    // Resize handler
    function handleResize() {
      const wasMobile = isMobile;
      isMobile = window.innerWidth < 1024;
      
      if (wasMobile !== isMobile) {
        updateSlideStates();
      }
    }

    window.addEventListener('resize', handleResize);

    // Initial setup
    setTimeout(() => {
      scrollToSlide(1);
      updateSlideStates();
    }, 100);

    // Cleanup
    return () => {
      window.removeEventListener('resize', handleResize);
    };
  }

  // Initialize on load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initServicesCarousel);
  } else {
    initServicesCarousel();
  }
</script>

<style>
  .services-carousel-wrapper {
    width: 100%;
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .services-carousel {
    width: 100%;
    max-width: 100%;
    margin: 0 auto;
    padding: 2rem 0;
    overflow: visible;
  }

  .services-track {
    display: flex;
    gap: 1rem;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    scroll-behavior: smooth;
    scrollbar-width: none;
    -ms-overflow-style: none;
    padding: 1rem 2rem;
    cursor: grab;
    will-change: scroll-position;
  }

  .services-track::-webkit-scrollbar {
    display: none;
  }

  .service-slide {
    flex: 0 0 auto;
    scroll-snap-align: center;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .service-card {
    position: relative;
    width: clamp(260px, 75vw, 320px);
    height: clamp(360px, 70vh, 520px);
    border-radius: 1rem;
    overflow: hidden;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    cursor: pointer;
    transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
    background-color: transparent;
  }

  .service-card.expanded {
    height: auto;
    max-height: clamp(500px, 85vh, 640px);
  }

  @media (min-width: 1024px) {
    .service-card {
      width: clamp(240px, 30vw, 280px);
      height: clamp(340px, 65vh, 480px);
      flex-direction: row;
    }

    .service-card.expanded {
      width: clamp(520px, 60vw, 680px);
      height: clamp(340px, 65vh, 480px);
    }
  }

  /* Image Section */
  .service-image-section {
    position: relative;
    width: 100%;
    height: 100%;
    transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    background-color: transparent;
  }

  .service-card.expanded .service-image-section {
    width: 100%;
    height: 50%;
    min-height: 240px;
    max-height: 300px;
    padding: 1rem;
  }

  @media (min-width: 1024px) {
    .service-card.expanded .service-image-section {
      width: 45%;
      height: 100%;
      min-height: unset;
      max-height: unset;
    }
  }

  .service-image-wrapper {
    position: relative;
    width: 100%;
    height: 100%;
    border-radius: 0.75rem;
    overflow: hidden;
  }

  .service-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .service-gradient {
    position: absolute;
    inset: 0;
    background: linear-gradient(to bottom, rgba(0,0,0,0.8), rgba(0,0,0,0.3), rgba(0,0,0,0.2));
    transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .service-card.expanded .service-gradient {
    background: linear-gradient(to bottom, rgba(0,0,0,0.6), rgba(0,0,0,0.2), rgba(0,0,0,0.1));
  }

  .service-title-overlay {
    position: absolute;
    top: 1.5rem;
    left: 1.5rem;
    right: 1.5rem;
    z-index: 10;
  }

  .service-title {
    font-family: 'Bricolage_Grotesque', Helvetica;
    color: #FFFFFF;
    font-size: clamp(28px, 9.2vw, 44px);
    font-weight: 500;
    line-height: 1.2;
    white-space: pre-line;
    word-break: break-word;
    overflow-wrap: anywhere;
  }

  @media (min-width: 1024px) {
    .service-title {
      font-size: 41px;
      line-height: normal;
    }
  }

  .service-card.expanded .service-title {
    font-size: clamp(26px, 8.2vw, 40px);
  }

  /* Content Section */
  .service-content-section {
    position: relative;
    width: 0;
    height: 0;
    opacity: 0;
    overflow: hidden;
    background-repeat: no-repeat;
    background-size: auto 80%;
    transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .service-card.expanded .service-content-section {
    width: 100%;
    height: 50%;
    min-height: 240px;
    opacity: 1;
    padding: 1.5rem 2rem 1.5rem 2rem;
  }

  @media (min-width: 1024px) {
    .service-card.expanded .service-content-section {
      width: 55%;
      height: 100%;
      min-height: unset;
      padding: 1.5rem 2rem;
    }
  }

  .service-content {
    display: flex;
    flex-direction: column;
    height: 100%;
    justify-content: space-between;
    position: relative;
    z-index: 1;
    gap: 1rem;
  }

  .services-list-wrapper {
    flex: 1;
    display: flex;
    align-items: flex-start;
    overflow-y: auto;
    overflow-x: hidden;
    max-height: 100%;
    padding-right: 0.5rem;
    scrollbar-width: thin;
    scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
  }

  .services-list-wrapper::-webkit-scrollbar {
    width: 4px;
  }

  .services-list-wrapper::-webkit-scrollbar-track {
    background: transparent;
  }

  .services-list-wrapper::-webkit-scrollbar-thumb {
    background-color: rgba(255, 255, 255, 0.3);
    border-radius: 2px;
  }

  .services-list-wrapper::-webkit-scrollbar-thumb:hover {
    background-color: rgba(255, 255, 255, 0.5);
  }

  .services-list {
    font-family: 'Be_Vietnam', Helvetica;
    color: rgba(255, 255, 255, 0.95);
    font-size: clamp(14px, 2vw, 18px);
    list-style: none;
    padding: 0;
    margin: 0;
    width: 100%;
  }

  .service-item {
    display: flex;
    align-items: start;
    opacity: 0;
    transform: translateX(32px);
    margin-bottom: 0.75rem;
  }

  @media (min-width: 1024px) {
    .service-item {
      margin-bottom: 1rem;
    }
  }

  .service-card.expanded .service-item {
    animation: slideInFromRight 0.5s ease-out forwards;
  }

  @keyframes slideInFromRight {
    from {
      opacity: 0;
      transform: translateX(32px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  .service-bullet {
    width: 0.5rem;
    height: 0.5rem;
    background-color: white;
    border-radius: 50%;
    margin-top: 0.5rem;
    margin-right: 0.75rem;
    flex-shrink: 0;
  }

  .service-text {
    line-height: 1.625;
  }

  .service-cta-btn {
    width: 100%;
    background-color: white;
    font-family: 'Be_Vietnam', Helvetica;
    font-weight: 700;
    border-radius: 9999px;
    padding: 1rem 1.5rem;
    font-size: clamp(17px, 4vw, 18px);
    transition: all 0.2s;
    border: none;
    cursor: pointer;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
    opacity: 0;
    letter-spacing: 0.025em;
    flex-shrink: 0;
    min-height: 48px;
  }

  @media (min-width: 1024px) {
    .service-cta-btn {
      padding: 0.75rem 1.5rem;
      font-size: 18px;
      font-weight: 600;
    }
  }

  .service-card.expanded .service-cta-btn {
    animation: slideInFromRight 0.5s ease-out 0.4s forwards;
  }

  .service-cta-btn:hover {
    background-color: #f9fafb;
    transform: scale(1.02);
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
  }

  .service-cta-btn:active {
    transform: scale(0.98);
  }
</style>
