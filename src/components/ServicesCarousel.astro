---
import { Image } from 'astro:assets';

interface Service {
  title: string;
  image: any;
  color: string;
  bgGradient?: string;
  services?: string[];
  bgRight?: any;
  bgRightPosition?: string;
  button?: string;
}

interface Props {
  slides: Service[];
  lang?: string;
}

const { slides, lang = 'es' } = Astro.props;
---

<div class="services-carousel-wrapper">
  <div class="services-carousel" data-carousel="services">
    <div class="services-carousel-container">
      <div class="services-track">
      {slides.map((slide, index) => (
        <div class="service-slide" data-slide-index={index}>
          <div class="service-card" data-color={slide.color}>
            {/* Image Section */}
            <div class="service-image-section" style={`background-color: ${slide.color}`}>
              <div class="service-image-wrapper">
                <Image
                  src={slide.image}
                  alt={slide.title}
                  class="service-image"
                  loading="lazy"
                  format="webp"
                  width={680}
                  height={480}
                />
                <div class="service-gradient"></div>
                <div class="service-title-overlay">
                  <h3 class="service-title">{slide.title.replace(' & ', ' &\n')}</h3>
                </div>
              </div>
            </div>

            {/* Content Section */}
            <div 
              class="service-content-section" 
              style={{
                backgroundColor: slide.color
              }}
            >
              {slide.bgRight && (
                <Image
                  src={slide.bgRight}
                  alt=""
                  class="service-bg-decoration"
                  loading="lazy"
                  format="webp"
                  width={400}
                  height={400}
                />
              )}
              {slide.services && (
                <div class="service-content">
                  {/* Services List */}
                  <div class="services-list-wrapper">
                    <ul class="services-list">
                      {slide.services.map((service, idx) => (
                        <li class="service-item" style={`animation-delay: ${idx * 0.1}s`}>
                          <span class="service-bullet"></span>
                          <span class="service-text">{service}</span>
                        </li>
                      ))}
                    </ul>
                  </div>

                  {/* CTA Button */}
                  {slide.button && (
                    <button 
                      class="service-cta-btn"
                      data-open-modal
                      style={`color: ${slide.color}`}
                    >
                      {slide.button}
                    </button>
                  )}
                </div>
              )}
            </div>
          </div>
        </div>
      ))}
      </div>
    </div>
  </div>
</div>

{/* Modal will be rendered by the section that includes this carousel */}

<script>
  function initServicesCarousel() {
    const carousel = document.querySelector('[data-carousel="services"]');
    if (!carousel) return;

    const container = carousel.querySelector('.services-carousel-container');
    if (!container) return;

    const track = container.querySelector('.services-track');
    if (!(track instanceof HTMLElement)) return;
    const trackEl = track;
    const handledCards = new WeakSet();

    const getSlides = () => Array.from(trackEl.querySelectorAll('.service-slide')).filter(el => el instanceof HTMLElement);

    let slides = getSlides();

    function forceSlideLayout() {
      slides.forEach(s => {
        s.style.display = s.style.display || 'flex';
        s.style.flex = s.style.flex || '0 0 auto';
        s.style.boxSizing = 'border-box';
      });
    }

    let selectedIndex = 0;
    let expandedIndex = null;
    let lastInteraction = 0;
    let isMobile = window.innerWidth < 1024;

    const getGap = () => {
      const gap = getComputedStyle(trackEl).gap;
      const px = parseFloat(gap);
      return Number.isFinite(px) && gap.includes('px') ? px : 16;
    };

    function imagesLoadedPromise() {
      const imgs = Array.from(container.querySelectorAll('img'));
      if (!imgs.length) return Promise.resolve();
      return Promise.all(imgs.map(img => {
        if (img.complete) return Promise.resolve();
        return new Promise(resolve => {
          img.addEventListener('load', resolve, { once: true });
          img.addEventListener('error', resolve, { once: true });
        });
      }));
    }

    function safeSlideWidth() {
      slides = getSlides();
      if (!slides[0]) return 0;
      const gap = getGap();
      const w = slides[0].offsetWidth || slides[0].getBoundingClientRect().width || 300;
      return w + gap;
    }

    function scrollToSlide(index) {
      slides = getSlides();
      if (!slides[0]) return;
      const gap = getGap();
      const representativeWidth = (slides[0].offsetWidth || slides[0].getBoundingClientRect().width) + gap;
      const left = Math.round(representativeWidth * index);
      const maxScroll = Math.max(0, trackEl.scrollWidth - trackEl.clientWidth);
      const finalLeft = Math.max(0, Math.min(maxScroll, left));
      trackEl.scrollTo({ left: finalLeft, behavior: 'smooth' });
    }

    function updateSelectedSlide() {
      const slideWidth = Math.max(1, safeSlideWidth());
      const currentIndex = Math.round(trackEl.scrollLeft / slideWidth);
      if (currentIndex !== selectedIndex) {
        selectedIndex = currentIndex;
        updateSlideStates();
      }
    }

    function updateSlideStates() {
      slides.forEach((slide, index) => {
        const card = slide.querySelector('.service-card');
        const isActive = index === selectedIndex;

        if (isMobile) {
          slide.style.transform = isActive ? 'scale(1)' : 'scale(0.90)';
          slide.style.opacity = isActive ? '1' : '0.5';
          slide.style.pointerEvents = isActive ? 'auto' : 'none';
        } else {
          slide.style.transform = 'scale(1)';
          slide.style.opacity = '1';
          slide.style.pointerEvents = 'auto';
        }
      });
    }

    function ensureFullyVisible(index) {
      slides = getSlides();
      const slide = slides[index];
      if (!slide) return;
      const card = slide.querySelector('.service-card');

      const slideRect = slide.getBoundingClientRect();
      const trackRect = trackEl.getBoundingClientRect();

      if (slideRect.left >= trackRect.left && slideRect.right <= trackRect.right) return;

      const cardRect = card.getBoundingClientRect();
      const cardCenterViewportX = cardRect.left + cardRect.width / 2;
      const offsetWithinTrack = cardCenterViewportX - trackRect.left;
      const targetLeft = trackEl.scrollLeft + offsetWithinTrack - trackEl.clientWidth / 2;

      const maxScroll = Math.max(0, trackEl.scrollWidth - trackEl.clientWidth);
      const finalLeft = Math.max(0, Math.min(maxScroll, targetLeft));

      const prevSnap = trackEl.style.scrollSnapType;
      trackEl.style.scrollSnapType = 'none';
      trackEl.scrollTo({ left: finalLeft, behavior: 'smooth' });

      setTimeout(() => { trackEl.style.scrollSnapType = prevSnap || 'x mandatory'; }, 350);
    }

    function toggleExpand(index) {
      slides = getSlides();
      const slide = slides[index];
      if (!slide) return false;
      const card = slide.querySelector('.service-card');

      if (expandedIndex === index) {
        expandedIndex = null;
        card.classList.remove('expanded');
        forceSlideLayout();
        return false;
      } else {
        slides.forEach(s => {
            const c = s.querySelector('.service-card');
            c && c.classList.remove('expanded');
          });
        expandedIndex = index;
        card.classList.add('expanded');
        forceSlideLayout();
        return true;
      }
    }

    function attachClickHandlers() {
      slides = getSlides();
      slides.forEach((slide, index) => {
        const card = slide.querySelector('.service-card');
        if (!card) return;
        if (handledCards.has(card)) return;
        handledCards.add(card);

        card.addEventListener('click', (e) => {
          const target = e.target;
          if (!(target instanceof Element)) return;
          if (target.hasAttribute('data-open-modal')) return;

          lastInteraction = performance.now();

          if (isMobile) {
            const isActive = index === selectedIndex;
            if (isActive) {
              toggleExpand(index);
            } else {
              scrollToSlide(index);
            }
          } else {
            if (index !== selectedIndex) {
              selectedIndex = index;
              scrollToSlide(index);
              updateSlideStates();
            }
            const opened = toggleExpand(index);
            if (opened) {
              setTimeout(() => ensureFullyVisible(index), 140);
            }
          }
        });
      });
    }

    document.querySelectorAll('[data-open-modal]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        window.dispatchEvent(new CustomEvent('openSubscriptionModal'));
      });
    });

    let isDragging = false;
    let startX = 0;
    let currentX = 0;
    let startScrollLeft = 0;
    let velocityX = 0;
    let lastX = 0;
    let lastTime = 0;
    let rafId = null;
    const dragThreshold = 5;
    let hasMoved = false;

    const applyMomentum = () => {
      if (Math.abs(velocityX) > 0.5) {
        trackEl.scrollLeft -= velocityX;
        velocityX *= 0.92;
        rafId = requestAnimationFrame(applyMomentum);
      } else {
        velocityX = 0;
        rafId = null;
      }
    };

    const handleMouseDown = (e) => {
      if (e.button !== 0) return;
      isDragging = true;
      hasMoved = false;
      trackEl.style.cursor = 'grabbing';
      trackEl.style.userSelect = 'none';
      trackEl.style.scrollSnapType = 'none';
      startX = e.pageX;
      currentX = e.pageX;
      lastX = e.pageX;
      startScrollLeft = trackEl.scrollLeft;
      lastTime = performance.now();
      velocityX = 0;
      if (rafId) { cancelAnimationFrame(rafId); rafId = null; }
      e.preventDefault();
    };

    const handleMouseMove = (e) => {
      if (!isDragging) return;
      e.preventDefault();
      currentX = e.pageX;
      const deltaX = currentX - startX;
      if (!hasMoved && Math.abs(deltaX) > dragThreshold) hasMoved = true;
      if (hasMoved) {
        const now = performance.now();
        const deltaTime = now - lastTime;
        const distance = currentX - lastX;
        const targetScroll = startScrollLeft - deltaX;
        trackEl.scrollLeft = targetScroll;
        if (deltaTime > 0) velocityX = (distance / deltaTime) * 16;
        lastX = currentX;
        lastTime = now;
      }
    };

    const handleMouseUp = () => {
      if (!isDragging) return;
      isDragging = false;
      trackEl.style.cursor = 'grab';
      trackEl.style.userSelect = '';
      setTimeout(() => { if (!isDragging) trackEl.style.scrollSnapType = 'x mandatory'; }, 50);
      if (hasMoved && Math.abs(velocityX) > 0.5) applyMomentum();
    };

    trackEl.addEventListener('mousedown', handleMouseDown);
    document.addEventListener('mousemove', handleMouseMove);
    document.addEventListener('mouseup', handleMouseUp);
    trackEl.addEventListener('click', (e) => { if (hasMoved) { e.preventDefault(); e.stopPropagation(); } }, true);

    let scrollTimeout;
    trackEl.addEventListener('scroll', () => {
      clearTimeout(scrollTimeout);
      scrollTimeout = window.setTimeout(() => updateSelectedSlide(), 100);
    }, { passive: true });

    function handleResize() {
      const wasMobile = isMobile;
      isMobile = window.innerWidth < 1024;
      if (wasMobile !== isMobile) updateSlideStates();
      forceSlideLayout();
      if (!isMobile && expandedIndex !== null) {
        setTimeout(() => ensureFullyVisible(expandedIndex), 120);
      }
    }
    window.addEventListener('resize', handleResize);

    imagesLoadedPromise().then(() => {
      slides = getSlides();
      forceSlideLayout();
      attachClickHandlers();

      if (!trackEl.style.scrollSnapType) trackEl.style.scrollSnapType = 'x mandatory';
      if (!trackEl.style.overflowX) trackEl.style.overflowX = 'auto';

      setTimeout(() => {
        scrollToSlide(0);
        updateSlideStates();
      }, 80);
    });

    // Cleanup
    return () => {
      window.removeEventListener('resize', handleResize);
      try { track.removeEventListener('mousedown', handleMouseDown); } catch(e){}
      try { document.removeEventListener('mousemove', handleMouseMove); } catch(e){}
      try { document.removeEventListener('mouseup', handleMouseUp); } catch(e){}
    };
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initServicesCarousel);
  } else {
    initServicesCarousel();
  }
</script>

<style>
  .services-carousel-wrapper {
    width: 100%;
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center; /* center the container that holds the carousel */
    background: transparent;
    box-shadow: none;
  }

  .services-carousel {
    width: 100%;
    max-width: 100%;
    margin: 0;
    padding-block: 3.5rem;
    padding-inline: 0;
    min-height: 560px;
    overflow: visible;
    background: transparent;
    box-shadow: none;
    display: block;
    box-sizing: border-box;
  }

  .services-carousel-container {
    position: relative;
    width: 100%;
    max-width: 100%; /* Mobile: full width */
    overflow: hidden; /* Critical: contains the scrollable track */
    margin: 0 auto;
  }

  @media (min-width: 1024px) {
    .services-carousel-container {
      max-width: 1600px; /* Wider container on desktop */
    }
  }

  .services-track {
    display: flex;
    gap: 0px; /* Mobile: no gap (cards touching) */
    padding: 0; /* Mobile: no horizontal padding */
    overflow-x: auto; /* Allow horizontal scroll */
    scroll-snap-type: x mandatory;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    -ms-overflow-style: none;
    cursor: grab;
    will-change: scroll-position;
    background: transparent;
    box-shadow: none;
    width: 100%;
    box-sizing: border-box;
  }

  @media (min-width: 1024px) {
    .services-track {
      gap: 1rem;
      padding: 0 0.5rem;
    }
  }

  .services-track .service-slide:last-child {
    margin-right: 0;
    padding-right: 0;
  }

  .service-image,
  .service-image img {
    display: block;
    border: none;
    outline: none;
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
  }

  .service-image-wrapper,
  .service-card {
    background-clip: padding-box;
  }

  .services-track::-webkit-scrollbar {
    display: none;
  }

  .service-slide {
    flex: 0 0 auto;
    scroll-snap-align: center; /* Mobile: center each card */
    padding: 0; /* Mobile: remove slide internal padding */
    display: flex;
    justify-content: center;
    align-items: center;
    transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    isolation: isolate;
    position: relative;
    z-index: 1;
  }

  @media (min-width: 1024px) {
    .service-slide {
      scroll-snap-align: start;
      padding: 0 0.5rem;
    }
  }
  .service-card {
    position: relative;
    width: clamp(260px, 75vw, 320px);
    height: clamp(360px, 70vh, 520px);
    border-radius: 1rem;
    overflow: hidden;
    box-shadow: none;
    cursor: pointer;
    transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
    background-color: transparent;
    isolation: isolate;
    z-index: 1;
  }

  .service-card.expanded {
    height: auto;
    max-height: clamp(500px, 85vh, 640px);
  }

  @media (min-width: 1024px) {
    .service-card {
      width: clamp(240px, 30vw, 280px);
      height: clamp(340px, 65vh, 480px);
      flex-direction: row;
    }

    .service-card.expanded {
      width: clamp(520px, 60vw, 680px);
      height: clamp(340px, 65vh, 480px);
    }
  }

  /* Image Section */
  .service-image-section {
    position: relative;
    width: 100%;
    height: 100%;
    transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    background-color: transparent;
  }

  .service-card.expanded .service-image-section {
    width: 100%;
    height: 50%;
    min-height: 240px;
    max-height: 300px;
    padding: 1rem;
  }

  @media (min-width: 1024px) {
    .service-card.expanded .service-image-section {
      width: 45%;
      height: 100%;
      min-height: unset;
      max-height: unset;
    }
  }

  .service-image-wrapper {
    position: relative;
    width: 100%;
    height: 100%;
    border-radius: 0.75rem;
    overflow: hidden;
  }

  .service-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .service-gradient {
    position: absolute;
    inset: 0;
    background: linear-gradient(to bottom, rgba(0,0,0,0.8), rgba(0,0,0,0.3), rgba(0,0,0,0.2));
    transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .service-card.expanded .service-gradient {
    background: linear-gradient(to bottom, rgba(0,0,0,0.6), rgba(0,0,0,0.2), rgba(0,0,0,0.1));
  }

  .service-title-overlay {
    position: absolute;
    top: 1.5rem;
    left: 1.5rem;
    right: 1.5rem;
    z-index: 10;
  }

  .service-title {
    font-family: 'Bricolage_Grotesque', Helvetica;
    color: #FFFFFF;
    font-size: clamp(28px, 9.2vw, 44px);
    font-weight: 500;
    line-height: 1.2;
    white-space: pre-line;
    word-break: break-word;
    overflow-wrap: anywhere;
  }

  @media (min-width: 1024px) {
    .service-title {
      font-size: 41px;
      line-height: normal;
    }
  }

  .service-card.expanded .service-title {
    font-size: clamp(26px, 8.2vw, 40px);
  }

  /* Content Section */
  .service-content-section {
    position: relative;
    width: 0;
    height: 0;
    opacity: 0;
    overflow: hidden;
    background-repeat: no-repeat;
    background-size: auto 80%;
    transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .service-card.expanded .service-content-section {
    width: 100%;
    height: 50%;
    min-height: 240px;
    opacity: 1;
    padding: 1.5rem 2rem 1.5rem 2rem;
  }

  @media (min-width: 1024px) {
    .service-card.expanded .service-content-section {
      width: 55%;
      height: 100%;
      min-height: unset;
      padding: 1.5rem 2rem;
    }
  }

  .service-bg-decoration {
    position: absolute;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    height: 80%;
    width: auto;
    object-fit: contain;
    pointer-events: none;
    z-index: 0;
    opacity: 0;
    transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .service-card.expanded .service-bg-decoration {
    opacity: 1;
  }
  .service-content {
    display: flex;
    flex-direction: column;
    height: 100%;
    justify-content: space-between;
    position: relative;
    z-index: 1;
    gap: 1rem;
  }

  .services-list-wrapper {
    flex: 1;
    display: flex;
    align-items: flex-start;
    overflow-y: auto;
    overflow-x: hidden;
    max-height: 100%;
    padding-right: 0.5rem;
    scrollbar-width: thin;
    scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
  }

  .services-list-wrapper::-webkit-scrollbar {
    width: 4px;
  }

  .services-list-wrapper::-webkit-scrollbar-track {
    background: transparent;
  }

  .services-list-wrapper::-webkit-scrollbar-thumb {
    background-color: rgba(255, 255, 255, 0.3);
    border-radius: 2px;
  }

  .services-list-wrapper::-webkit-scrollbar-thumb:hover {
    background-color: rgba(255, 255, 255, 0.5);
  }

  .services-list {
    font-family: 'Be_Vietnam', Helvetica;
    color: rgba(255, 255, 255, 0.95);
    font-size: clamp(14px, 2vw, 18px);
    list-style: none;
    padding: 0;
    margin: 0;
    width: 100%;
  }

  .service-item {
    display: flex;
    align-items: start;
    opacity: 0;
    transform: translateX(32px);
    margin-bottom: 0.75rem;
  }

  @media (min-width: 1024px) {
    .service-item {
      margin-bottom: 1rem;
    }
  }

  .service-card.expanded .service-item {
    animation: slideInFromRight 0.5s ease-out forwards;
  }

  @keyframes slideInFromRight {
    from {
      opacity: 0;
      transform: translateX(32px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  .service-bullet {
    width: 0.5rem;
    height: 0.5rem;
    background-color: white;
    border-radius: 50%;
    margin-top: 0.5rem;
    margin-right: 0.75rem;
    flex-shrink: 0;
  }

  .service-text {
    line-height: 1.625;
  }

  .service-cta-btn {
    width: 100%;
    background-color: white;
    font-family: 'Be_Vietnam', Helvetica;
    font-weight: 700;
    border-radius: 9999px;
    padding: 1rem 1.5rem;
    font-size: clamp(17px, 4vw, 18px);
    transition: all 0.2s;
    border: none;
    cursor: pointer;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
    opacity: 0;
    letter-spacing: 0.025em;
    flex-shrink: 0;
    min-height: 48px;
  }

  @media (min-width: 1024px) {
    .service-cta-btn {
      padding: 0.75rem 1.5rem;
      font-size: 18px;
      font-weight: 600;
    }
  }

  .service-card.expanded .service-cta-btn {
    animation: slideInFromRight 0.5s ease-out 0.4s forwards;
  }

  .service-cta-btn:hover {
    background-color: #f9fafb;
    transform: scale(1.02);
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
  }

  .service-cta-btn:active {
    transform: scale(0.98);
  }
</style>
